#!/bin/bash

# Usage check
if [ -z "$1" ]; then
    echo "Usage: $0 <username> [report_file]"
    echo "Example: $0 tes716 scanreport.txt"
    exit 1
fi

USERNAME="$1"
REPORT_FILE="${2:-scanreport.txt}"  # Default to scanreport.txt if not provided

# Determine the base home directory path
# This example assumes /home or /home4, check existence to decide
if [ -d "/home/$USERNAME" ]; then
    HOME_DIR="/home/$USERNAME"
elif [ -d "/home4/$USERNAME" ]; then
    HOME_DIR="/home4/$USERNAME"
else
    echo "Error: Home directory for user '$USERNAME' not found under /home or /home4."
    exit 1
fi

DEST_FOLDER="$HOME_DIR/infected_files"

# Create destination folder if it doesn't exist
if [ ! -d "$DEST_FOLDER" ]; then
    mkdir -p "$DEST_FOLDER"
    echo "Created destination folder: $DEST_FOLDER"
fi

moved_count=0

echo "Processing infected files listed in $REPORT_FILE ..."

while IFS= read -r line || [ -n "$line" ]; do
    # Skip empty lines
    if [ -z "$line" ]; then
        continue
    fi

    # Extract file path before first colon
    file_path="${line%%:*}"

    # Trim whitespace
    file_path=$(echo "$file_path" | xargs)

    # Check if file exists and is a regular file
    if [ -f "$file_path" ]; then
        base_name=$(basename "$file_path")
        timestamp=$(date +%Y%m%d_%H%M%S%3N)  # timestamp with milliseconds
        new_name="${timestamp}_${base_name}"

        if mv "$file_path" "$DEST_FOLDER/$new_name"; then
            echo "Moved: $file_path -> $DEST_FOLDER/$new_name"
            ((moved_count++))
        else
            echo "Failed to move: $file_path"
        fi
    else
        echo "File not found or not a regular file, skipping: $file_path"
    fi
done < "$REPORT_FILE"

# Final summary
if [ $moved_count -eq 0 ]; then
    echo "No infected files were moved."
else
    echo ""
    echo "Summary: Moved $moved_count infected file(s) to $DEST_FOLDER/"
fi